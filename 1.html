<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¥åº·è«®è©¢ + åˆæ­¥åˆ†è¨ºèŠå¤©æ©Ÿå™¨äººï¼ˆDemoï¼‰</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#60a5fa;--muted:#9aa7b2;--glass: rgba(255,255,255,0.04)}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans TC',sans-serif}
    body{margin:0;background:linear-gradient(180deg,#071027 0%, #071724 100%);color:#e6eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .app{width:100%;max-width:980px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    header{display:flex;gap:16px;align-items:center;margin-bottom:12px}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7dd3fc);display:flex;align-items:center;justify-content:center;font-weight:700;color:#03203a}
    h1{margin:0;font-size:18px}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .content{display:grid;grid-template-columns:1fr 420px;gap:18px}
    .panel{background:var(--card);border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.03)}

    /* Left: chat / triage */
    .chat-wrap{display:flex;flex-direction:column;height:68vh}
    .chat-log{flex:1;overflow:auto;padding:12px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .msg{margin-bottom:12px;display:flex;gap:10px}
    .msg.user{justify-content:flex-end}
    .bubble{max-width:74%;padding:10px 12px;border-radius:10px;background:var(--glass);font-size:14px;color:#e6eef6}
    .bubble.user{background:linear-gradient(90deg,var(--accent),#7dd3fc);color:#04223a}
    .meta{font-size:12px;color:var(--muted);margin-top:6px}

    .controls{display:flex;gap:8px;margin-top:8px}
    .input{flex:1;display:flex;gap:8px}
    input[type=text]{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    button{padding:10px 12px;border-radius:8px;border:0;background:var(--accent);color:#03203a;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

    /* Right: controls */
    .side{display:flex;flex-direction:column;gap:10px;height:68vh}
    .section{padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    textarea,select,input[type=number]{width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:inherit}
    .red-flag{background:linear-gradient(90deg,#ff7a7a,#ffb199);color:#300;background-clip:padding-box;padding:8px;border-radius:8px;font-weight:700}
    .summary{white-space:pre-wrap;font-family:monospace;font-size:13px;background:rgba(255,255,255,0.02);padding:8px;border-radius:6px;border:1px dashed rgba(255,255,255,0.02)}

    footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:var(--muted);font-size:13px}
    .pill{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}

    @media (max-width:980px){.content{grid-template-columns:1fr;}.side{height:auto}.chat-wrap{height:56vh}}
  </style>
</head>
<body>
  <div class="app" role="application">
    <header>
      <div class="logo">HT</div>
      <div>
        <h1>å¥åº·è«®è©¢èˆ‡åˆæ­¥åˆ†è¨º Chatbot â€” Demo</h1>
        <p class="lead">Hybrid triageï¼šè‡¨åºŠè¦å‰‡ + ç”Ÿæˆå¼ AI è¼”åŠ©èªæ„ç†è§£ï¼ˆç¤ºç¯„ç‰ˆï¼‰</p>
      </div>
    </header>

    <div class="content">
      <div class="panel chat-wrap">
        <div id="chatLog" class="chat-log" aria-live="polite"></div>

        <div class="controls">
          <div class="input">
            <input id="userInput" type="text" placeholder="è«‹æè¿°ä½ çš„ç—‡ç‹€ï¼ˆä¾‹å¦‚ï¼šç™¼ç‡’å…©å¤©ã€èƒ¸ç—›ï¼‰" />
            <button id="sendBtn">é€å‡º</button>
          </div>
          <button id="voiceBtn" class="ghost">ğŸ¤ èªéŸ³</button>
        </div>

        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="meta">æç¤ºï¼šæ­¤ç³»çµ±ç‚ºç¤ºç¯„ï¼Œè‹¥æœ‰ç·Šæ€¥æƒ…æ³è«‹ç«‹å³å°±é†«ã€‚</div>
          <div>
            <button id="exportSummary" class="ghost">åŒ¯å‡ºæ‘˜è¦</button>
            <button id="simulateEHR" class="ghost">æ¨¡æ“¬ EHR åŒæ­¥</button>
          </div>
        </div>
      </div>

      <aside class="panel side">
        <div class="section">
          <label>ç—…æ‚£è³‡è¨Šï¼ˆç¤ºç¯„ï¼‰</label>
          <input id="patientName" type="text" placeholder="å§“åï¼šç‹å°æ˜" value="ç‹å°æ˜" />
          <div style="display:flex;gap:8px;margin-top:8px"><input id="patientAge" type="number" placeholder="å¹´é½¡" value="28" /><select id="patientSex"><option>ç”·</option><option>å¥³</option></select></div>
        </div>

        <div class="section">
          <label>ç´…æ——ï¼ˆRed flagsï¼‰å³æ™‚åµæ¸¬</label>
          <div id="redFlagBox" class="summary">ç›®å‰ç„¡åµæ¸¬åˆ°ç´…æ——ç—‡ç‹€</div>
        </div>

        <div class="section">
          <label>å³æ™‚åˆ†è¨ºå»ºè­°ï¼ˆMVPï¼‰</label>
          <div id="triageResult" class="summary">å°šæœªè¼¸å…¥ç—‡ç‹€</div>
        </div>

        <div class="section">
          <label>è‡¨åºŠæ‘˜è¦ï¼ˆè¼¸å‡ºçµ¦é†«è­·ï¼‰</label>
          <div id="structuredSummary" class="summary">å°šç„¡æ‘˜è¦</div>
        </div>

        <div class="section">
          <label>éš±ç§èˆ‡ä½¿ç”¨èªªæ˜</label>
          <div style="font-size:13px;color:var(--muted)">æ­¤ Demo ä¸å„²å­˜å€‹è³‡ã€‚æ­£å¼é‹ä½œéœ€éµå®ˆç•¶åœ°é†«ç™‚è³‡æ–™ä¿è­·è¦å®šèˆ‡è‡¨åºŠé©—è­‰ã€‚</div>
        </div>
      </aside>
    </div>

    <footer>
      <div class="pill">Hybrid: Rules + LLM</div>
      <div>ç¤ºç¯„ç‰ˆ â€¢ ä¸å–ä»£é†«ç™‚åˆ¤æ–·</div>
    </footer>
  </div>

  <script>
    // --- åŸºæœ¬è³‡æ–™èˆ‡ç´…æ——è¦å‰‡ï¼ˆå¯ä¾é†«é™¢èª¿æ•´ï¼‰
    const RED_FLAG_KEYWORDS = [
      'èƒ¸ç—›','å‘¼å¸å›°é›£','ç„¡æ„è­˜','æ„è­˜ä¸æ¸…','åš´é‡å‡ºè¡€','æ˜å¥','ä¸­é¢¨','ç™²ç™‡','çªç„¶è¦–åŠ›è®Šå·®','åš´é‡éæ•','åŠ‡çƒˆè…¹ç—›'
    ];

    const chatLog = document.getElementById('chatLog');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    const redFlagBox = document.getElementById('redFlagBox');
    const triageResult = document.getElementById('triageResult');
    const structuredSummary = document.getElementById('structuredSummary');
    const exportSummary = document.getElementById('exportSummary');
    const simulateEHR = document.getElementById('simulateEHR');

    function appendMessage(text, who='bot'){
      const container = document.createElement('div');
      container.className = 'msg ' + (who==='user' ? 'user' : 'bot');
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (who==='user' ? 'user' : '');
      bubble.textContent = text;
      container.appendChild(bubble);
      chatLog.appendChild(container);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function evaluateRedFlags(text){
      const found = [];
      const lower = text.replace(/[\s,ï¼Œã€‚ï¼Ÿï¼]/g,'').toLowerCase();
      for(const kw of RED_FLAG_KEYWORDS){
        if(lower.includes(kw)) found.push(kw);
      }
      return found;
    }

    function simpleTriage(symptoms, age, sex){
      // åŸºæœ¬ hybrid é‚è¼¯ç¤ºç¯„
      const red = evaluateRedFlags(symptoms);
      if(red.length>0){
        return {level:'ç·Šæ€¥ï¼ˆç«‹å³å°±é†«ï¼‰', reason:'åµæ¸¬åˆ°ç´…æ——ç—‡ç‹€ï¼š'+red.join(', '), redFlags:red};
      }
      // è‹¥å¹´é½¡é«˜æ–¼75ä¸”æœ‰ç™¼ç‡’æˆ–è·Œå€’ç›¸é—œï¼Œæå‡ç­‰ç´š
      if(age>=75 && /ç™¼ç‡’|è·Œå€’|å˜”å/.test(symptoms)){
        return {level:'å»ºè­°é–€è¨ºæˆ–æ€¥è¨ºè©•ä¼°', reason:'é«˜é½¡èˆ‡ç—‡ç‹€åˆä½µï¼Œå»ºè­°è©•ä¼°'};
      }
      // éç·Šæ€¥å¸¸è¦‹ç—‡ç‹€ -> å»ºè­°å±…å®¶ç…§è­·æˆ–é–€è¨º
      if(/ç™¼ç‡’|å’³å—½|é ­ç—›|å–‰åš¨ç—›|æµé¼»æ°´|è…¹ç€‰/.test(symptoms)){
        return {level:'å±…å®¶ç…§è­·æˆ–é ç´„é–€è¨º', reason:'ç—‡ç‹€çœ‹ä¼¼è¼•å¾®æˆ–å¸¸è¦‹æ„ŸæŸ“æ€§ç—‡ç‹€'};
      }
      // ç„¡æ³•åˆ¤å®š -> å»ºè­°ç·šä¸Šè«®è©¢æˆ–äººå·¥åˆ†è¨º
      return {level:'éœ€è¦äººå·¥è©•ä¼°', reason:'èªæ„ä¸è¶³æˆ–ä¸ç¢ºå®š'};
    }

    async function callLLMForFollowups(symptoms, age, sex){
      // åœ¨çœŸå¯¦æ‡‰ç”¨ä¸­ï¼Œé€™è£¡æœƒå‘¼å«å¾Œç«¯ APIï¼ˆä¾‹å¦‚ /api/triage ï¼‰
      // API æ‡‰ä»¥è‡¨åºŠè¦å‰‡ + LLM hybrid è¿”å›è£œå•å¥èˆ‡æ›´è©³ç›¡æ‘˜è¦ã€‚
      // é€™è£¡æä¾› mock è¡Œç‚ºä»¥ç¤ºç¯„å‰ç«¯æ•´åˆã€‚

      // è­¦ç¤ºï¼šè‹¥è¦ä¸²å¯¦éš› LLMï¼Œè«‹ä½¿ç”¨å¾Œç«¯ä»£ç†åŠé†«ç™‚è³‡å®‰æ©Ÿåˆ¶ï¼ˆä¸è¦åœ¨å®¢æˆ¶ç«¯æ”¾ API Keyï¼‰ã€‚

      // æ¨¡æ“¬å»¶é²
      await new Promise(r=>setTimeout(r,700));

      // è‹¥å…§å®¹å¤ªçŸ­ï¼Œè«‹æ±‚æ¨¡å‹è£œå•
      if(symptoms.trim().length < 6){
        return {
          followups:['ä½ ç™¼ä½œå¤šä¹…äº†ï¼Ÿ','æœ‰ç™¼ç‡’æˆ–æœè—¥æƒ…æ³å—ï¼Ÿ','ç›®å‰æ˜¯å¦æœ‰å‘¼å¸æ€¥ä¿ƒæˆ–èƒ¸ç—›ï¼Ÿ'],
          summary:`ä¸»è¨´ï¼š${symptoms}\nå»ºè­°ï¼šè«‹è£œå……ç™¼ç—…æ™‚é–“ã€æ˜¯å¦ç™¼ç‡’ã€æ˜¯å¦æœ‰æ…¢æ€§ç—…/ç”¨è—¥`,
          confidence:0.45
        };
      }

      // æ¨¡æ“¬ç”Ÿæˆçš„æ‘˜è¦èˆ‡å»ºè­°
      const summaryParts = [];
      summaryParts.push(`ä¸»è¨´ï¼š${symptoms}`);
      summaryParts.push(`å¹´é½¡/æ€§åˆ¥ï¼š${age}/${sex}`);
      summaryParts.push('ç›®å‰åˆæ­¥åˆ¤æ–·ï¼šä¾ç—‡ç‹€å¯èƒ½ç‚ºä¸Šå‘¼å¸é“æ„ŸæŸ“æˆ–ä¸€èˆ¬æ€§ç—…æ¯’ã€‚');
      summaryParts.push('å»ºè­°ï¼šè‹¥48å°æ™‚å…§ç—‡ç‹€æƒ¡åŒ–ï¼ˆå‘¼å¸å›°é›£ã€é«˜ç‡’æŒçºŒã€æ„è­˜ä¸æ¸…ï¼‰ï¼Œè«‹ç«‹å³å°±é†«ã€‚');

      return {
        followups:[],
        summary:summaryParts.join('\n'),
        confidence:0.78
      };
    }

    // ä¸»æµç¨‹
    async function handleSubmit(){
      const text = userInput.value.trim();
      if(!text) return;
      appendMessage(text,'user');
      userInput.value='';

      // å…ˆç”¨è¦å‰‡åµæ¸¬ç´…æ——
      const age = Number(document.getElementById('patientAge').value) || 0;
      const sex = document.getElementById('patientSex').value;
      const red = evaluateRedFlags(text);
      if(red.length>0){
        redFlagBox.textContent = 'åµæ¸¬åˆ°ç´…æ——ï¼š' + red.join(', ');
      } else {
        redFlagBox.textContent = 'ç›®å‰ç„¡åµæ¸¬åˆ°ç´…æ——ç—‡ç‹€';
      }

      // å…ˆçµ¦å‡ºç°¡å–® triage å»ºè­°
      const triage = simpleTriage(text, age, sex);
      triageResult.textContent = `${triage.level}\nåŸå› ï¼š${triage.reason}`;

      // å‘¼å«ï¼ˆæ¨¡æ“¬ï¼‰LLM ä»¥å–å¾—è£œå•å¥èˆ‡è‡¨åºŠæ‘˜è¦
      appendMessage('ç³»çµ±æ­£åœ¨åˆ†æï¼ˆè¦å‰‡ + AIï¼‰â€¦');
      const llm = await callLLMForFollowups(text, age, sex);

      // è‹¥ LLM å›å‚³è£œå•å•é¡Œï¼Œå‰‡è©¢å•ç—…æ‚£
      if(llm.followups && llm.followups.length>0){
        // é¡¯ç¤ºè£œå•
        for(const q of llm.followups){
          appendMessage(q,'bot');
        }
        appendMessage('è«‹è£œå……ä¸Šè¿°å•é¡Œï¼Œä»¥ä¾¿æ›´ç²¾æº–åˆ¤æ–·ã€‚');
        structuredSummary.textContent = llm.summary;
        return;
      }

      // åˆä½µè¼¸å‡ºçµ¦ä½¿ç”¨è€…èˆ‡é†«è­·
      const finalMsg = `${triage.level}\n${triage.reason}\nï¼ˆAI å»ºè­°ä¿¡å¿ƒåº¦ ${Math.round(llm.confidence*100)}%ï¼‰`;
      appendMessage(finalMsg,'bot');
      structuredSummary.textContent = llm.summary;

      // è‹¥ç³»çµ±ç‚ºç·Šæ€¥ -> é¡¯ç¤ºç´…è‰²æé†’æ³¡æ³¡
      if(triage.level.includes('ç·Šæ€¥')){
        appendMessage('ç³»çµ±åˆ¤å®šå¯èƒ½ç‚ºç·Šæ€¥æƒ…æ³ï¼Œè«‹ç«‹å³å°±é†«æˆ–æ’¥æ‰“ç·Šæ€¥é›»è©±ã€‚','bot');
      }
    }

    sendBtn.addEventListener('click',handleSubmit);
    userInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleSubmit(); });

    // ç°¡å–®çš„èªéŸ³å•Ÿå‹•ï¼ˆç¤ºç¯„ï¼Œéœ€ HTTPS èˆ‡ç€è¦½å™¨æ”¯æ´ï¼‰
    let recognition;
    if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
      const R = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new R();
      recognition.lang = 'zh-TW';
      recognition.interimResults = false;
      recognition.onresult = (e)=>{ const t = e.results[0][0].transcript; userInput.value = t; handleSubmit(); };
      recognition.onerror = (e)=>{ appendMessage('èªéŸ³è¾¨è­˜éŒ¯èª¤ï¼Œè«‹æ”¹ç”¨æ–‡å­—è¼¸å…¥ã€‚','bot'); };
    } else {
      voiceBtn.disabled = true;
      voiceBtn.title = 'æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜';
    }
    voiceBtn.addEventListener('click', ()=>{ if(recognition){ recognition.start(); appendMessage('é–‹å§‹éŒ„éŸ³â€¦ï¼ˆèªªè©±ä¸­ï¼‰','bot'); }});

    // åŒ¯å‡ºæ‘˜è¦ï¼ˆä¸‹è¼‰ JSONï¼‰
    exportSummary.addEventListener('click', ()=>{
      const payload = {
        patient: {name:document.getElementById('patientName').value, age:document.getElementById('patientAge').value, sex:document.getElementById('patientSex').value},
        summary: structuredSummary.textContent,
        triage: triageResult.textContent,
        timestamp: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = 'triage_summary.json'; a.click(); URL.revokeObjectURL(url);
    });

    simulateEHR.addEventListener('click', ()=>{
      // æ¨¡æ“¬å‘é™¢å…§ EHR å‚³é€ï¼ˆåƒ…ç¤ºç¯„ï¼‰
      const data = {patient:document.getElementById('patientName').value, summary:structuredSummary.textContent};
      appendMessage('æ¨¡æ“¬å·²å°‡æ‘˜è¦å‚³é€è‡³é™¢å…§ EHRï¼ˆç¤ºç¯„ï¼‰');
      console.log('EHR payload', data);
    });

    // åˆå§‹æç¤º
    appendMessage('æ­¡è¿ä½¿ç”¨å¥åº·è«®è©¢ Chatbotï¼ˆDemoï¼‰ã€‚è«‹ç°¡è¿°ä½ çš„ç—‡ç‹€ï¼Œä¾‹å¦‚ï¼š"ç™¼ç‡’å…©å¤©ã€å’³å—½"ã€‚');
  </script>
</body>
</html>
